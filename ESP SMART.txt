-- LocalScript (Advanced ESP v8 - Streaming Enabled, Auto Update & Chat Toggle)

-- ============== LAYANAN ==============
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Teams = game:GetService("Teams")
local workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui") -- Untuk Notifikasi

-- ============== PEMAIN LOKAL ==============
local LocalPlayer = Players.LocalPlayer
local LocalCamera = workspace.CurrentCamera

-- ============== GLOBAL SWITCH ==============
local MASTER_ENABLED = true -- Default: ESP Nyala. Ubah lewat chat /espoff

-- ============== KONFIGURASI TAMPILAN ==============
local ESP_SETTINGS = {
	NAME = "StreamESP_v8",
	
	-- Warna
	COLOR_ENEMY = Color3.fromRGB(255, 60, 60),    
	COLOR_TEAM = Color3.fromRGB(0, 255, 120),      
	COLOR_NEUTRAL = Color3.fromRGB(255, 255, 255), 
	
	-- Highlight
	SHOW_HIGHLIGHT = true,
	FILL_TRANS = 0.5,
	OUTLINE_TRANS = 0.1,
	
	-- Name Tag
	SHOW_NAMETAG = true,
	TEXT_SIZE = 13,         
	MAX_TEXT_DIST = 1500,     -- Jarak maksimal nama terlihat
	
	-- PENTING UNTUK MAP BESAR
	MAX_RENDER_DIST = 10000,   -- Jarak highlight aktif
}

-- ============== PENYIMPANAN DATA ==============
local trackedPlayers = {} 

-- ============== FUNGSI UTILITAS ==============

-- Notifikasi sistem
local function Notify(text)
	StarterGui:SetCore("SendNotification", {
		Title = "ESP System",
		Text = text,
		Duration = 3,
	})
end

-- Cek apakah objek valid
local function isValid(instance)
	return instance and instance.Parent
end

local function createHeadTag()
	local bb = Instance.new("BillboardGui")
	bb.Name = "ESP_Tag"
	bb.Size = UDim2.new(0, 200, 0, 50)
	bb.StudsOffset = Vector3.new(0, 3.5, 0)
	bb.AlwaysOnTop = true
	bb.MaxDistance = ESP_SETTINGS.MAX_TEXT_DIST

	local container = Instance.new("Frame")
	container.BackgroundTransparency = 1
	container.Size = UDim2.fromScale(1,1)
	container.Parent = bb

	local bg = Instance.new("Frame")
	bg.BackgroundColor3 = Color3.new(0,0,0)
	bg.BackgroundTransparency = 0.5
	bg.AnchorPoint = Vector2.new(0.5, 0.5)
	bg.Position = UDim2.fromScale(0.5, 0.5)
	bg.Parent = container
	
	local uic = Instance.new("UICorner")
	uic.CornerRadius = UDim.new(0, 4)
	uic.Parent = bg

	local txt = Instance.new("TextLabel")
	txt.Parent = bg
	txt.BackgroundTransparency = 1
	txt.Size = UDim2.fromScale(1,1)
	txt.Font = Enum.Font.GothamBold
	txt.TextSize = ESP_SETTINGS.TEXT_SIZE
	txt.TextStrokeTransparency = 0.5
	txt.TextColor3 = Color3.new(1,1,1)
	
	return bb, bg, txt
end

local function getRelationData(player)
	if player == LocalPlayer then return nil, nil end
	if #Teams:GetTeams() > 1 and LocalPlayer.Team then
		if player.Team == LocalPlayer.Team then return "Friend", ESP_SETTINGS.COLOR_TEAM end
		return "Enemy", ESP_SETTINGS.COLOR_ENEMY
	end
	return "Neutral", ESP_SETTINGS.COLOR_NEUTRAL
end

-- ============== MANAJEMEN PEMAIN ==============

-- 1. Membersihkan data
local function cleanupPlayer(player)
	if trackedPlayers[player] then
		local data = trackedPlayers[player]
		if data.connections then
			for _, c in pairs(data.connections) do c:Disconnect() end
		end
		if data.highlight then data.highlight:Destroy() end
		if data.billboard then data.billboard:Destroy() end
		trackedPlayers[player] = nil
	end
end

-- 2. Setup Awal Pemain
local function registerPlayer(player)
	if player == LocalPlayer then return end
	cleanupPlayer(player)

	local data = {
		player = player,
		character = nil,    
		highlight = nil,
		billboard = nil,
		visualsReady = false,
		connections = {}
	}
	trackedPlayers[player] = data

	-- Monitor karakter ditambahkan
	data.connections.CharAdded = player.CharacterAdded:Connect(function(char)
		data.character = char
		data.visualsReady = false -- Reset karena ganti tubuh
	end)

	if player.Character then
		data.character = player.Character
	end
end

-- 3. Fungsi Pemasangan Visual
local function tryAttachVisuals(data)
	local char = data.character
	if not isValid(char) then return false end
	
	local root = char:FindFirstChild("HumanoidRootPart")
	local hum = char:FindFirstChild("Humanoid")
	local head = char:FindFirstChild("Head") 

	if not root or not hum or not head then return false end

	-- A. Highlight
	if ESP_SETTINGS.SHOW_HIGHLIGHT then
		local hl = Instance.new("Highlight")
		hl.Name = ESP_SETTINGS.NAME .. "_HL"
		hl.Adornee = char
		hl.FillTransparency = ESP_SETTINGS.FILL_TRANS
		hl.OutlineTransparency = ESP_SETTINGS.OUTLINE_TRANS
		hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
		hl.Parent = char
		data.highlight = hl
	end

	-- B. NameTag
	if ESP_SETTINGS.SHOW_NAMETAG then
		local bb, bg, txt = createHeadTag()
		bb.Adornee = head
		bb.Parent = head
		data.billboard = bb
		data.bgFrame = bg
		data.textLabel = txt
	end

	data.rootPart = root
	data.humanoid = hum
	data.headPart = head
	data.visualsReady = true
	return true
end

-- ============== COMMAND CHAT LOGIC ==============

LocalPlayer.Chatted:Connect(function(msg)
	local message = string.lower(msg)
	
	if message == "/espon" then
		if not MASTER_ENABLED then
			MASTER_ENABLED = true
			Notify("Visuals ENABLED")
		end
	elseif message == "/espoff" then
		if MASTER_ENABLED then
			MASTER_ENABLED = false
			Notify("Visuals DISABLED")
		end
	end
end)


-- ============== LOOP UTAMA (HEARTBEAT) ==============

RunService.Heartbeat:Connect(function()
	local camPos = LocalCamera.CFrame.Position
	
	for player, data in pairs(trackedPlayers) do
		-- ### 1. Cek Switch Global (Toggle Command)
		if not MASTER_ENABLED then
			-- Jika ESP dimatikan, sembunyikan semua UI & Lanjut ke player berikutnya
			if data.highlight then data.highlight.Enabled = false end
			if data.billboard then data.billboard.Enabled = false end
			continue
		end

		-- ### 2. Logic Streaming & Setup Visual
		if data.character and isValid(data.character) and not data.visualsReady then
			tryAttachVisuals(data)
		end

		-- ### 3. Logic Render (Update Posisi/Warna)
		if data.visualsReady and isValid(data.rootPart) and isValid(data.humanoid) then
			-- Cek hidup mati
			if data.humanoid.Health <= 0 then
				if data.highlight then data.highlight.Enabled = false end
				if data.billboard then data.billboard.Enabled = false end
				continue 
			end

			local dist = (data.rootPart.Position - camPos).Magnitude
			
			if dist <= ESP_SETTINGS.MAX_RENDER_DIST then
				local _, baseColor = getRelationData(player)
				
				-- Warna Darah
				local hpFactor = data.humanoid.Health / data.humanoid.MaxHealth
				local finalColor = baseColor:Lerp(Color3.new(0,0,0), (1 - hpFactor) * 0.6)

				-- UPDATE HIGHLIGHT
				if data.highlight then
					data.highlight.Enabled = true
					data.highlight.FillColor = finalColor
					data.highlight.OutlineColor = Color3.new(1,1,1)
				end

				-- UPDATE NAMETAG
				if data.billboard then
					if dist <= ESP_SETTINGS.MAX_TEXT_DIST then
						data.billboard.Enabled = true
						local nameStr = player.DisplayName
						if ESP_SETTINGS.SHOW_NAMETAG then
							nameStr = string.format("%s [%d%%]", nameStr, math.floor(hpFactor*100))
						end
						
						data.textLabel.Text = nameStr
						data.textLabel.TextColor3 = baseColor
						
						local bSize = data.textLabel.TextBounds
						data.bgFrame.Size = UDim2.new(0, bSize.X + 16, 0, bSize.Y + 4)
					else
						data.billboard.Enabled = false
					end
				end
			else
				-- Terlalu jauh
				if data.highlight then data.highlight.Enabled = false end
				if data.billboard then data.billboard.Enabled = false end
			end
		else
			-- Objek Hilang (Streaming Out)
			if data.highlight then data.highlight.Enabled = false end
			if data.billboard then data.billboard.Enabled = false end
			
			if data.character and isValid(data.character) and not isValid(data.rootPart) then
				data.visualsReady = false -- Siapkan untuk re-attach nanti
			end
		end
	end
end)

-- ============== INISIALISASI ==============
for _, p in ipairs(Players:GetPlayers()) do
	registerPlayer(p)
end

Players.PlayerAdded:Connect(registerPlayer)
Players.PlayerRemoving:Connect(cleanupPlayer)
LocalPlayer:GetPropertyChangedSignal("Team"):Connect(function() end)

Notify("ESP Loaded: Chat /espon or /espoff")
print("âœ… ESP v8 Ready (Cmds & Stream Fix)")